
import time
import random
from datetime import datetime
from backend_core import log_system, execute_query, STOP_FLAGS, ACTIVE_CAMPAIGNS
from backend_tools import process_spintax, check_history_exists, add_friend
from backend_worker_common import generate_text, send_message_core, update_conversation_db
from backend_health import update_account_health, get_adaptive_delay

def process_account_step(account_id, campaign_name, templates_pool, constructor_options, attachments):
    """
    KAIZEN_MODE: High-Load Optimized Step with PROJECT ISOLATION.
    """
    
    # 1. FAIL-FAST
    if STOP_FLAGS.get(campaign_name): return 'stop', 0
    settings = ACTIVE_CAMPAIGNS.get(campaign_name)
    if not settings: return 'stop', 0
    
    # Get Project ID from settings
    project_id = settings.get('project_id', 1)

    try:
        # 2. FETCH ACCOUNT (INCLUDE USER_AGENT)
        acc = execute_query(
            "SELECT id, vk_user_id, name, avatar, status, access_token, kamikaze_mode, day_limit, messages_sent_today, cached_friends_list, user_agent FROM accounts WHERE id=?", 
            (account_id,), 
            fetch_one=True
        )
        
        if not acc: return 'no_work', 60
        if acc['status'] != 'OK': return 'no_work', 60 

        # 3. HEALTH & LIMITS CHECK
        acc_dict = dict(acc)
        is_kamikaze = bool(acc_dict.get('kamikaze_mode', 0))
        day_limit = acc_dict.get('day_limit', 20)
        sent_today = acc_dict.get('messages_sent_today', 0)
        user_agent = acc_dict.get('user_agent', None) # Get UA
        
        health = update_account_health(account_id, 'check')
        if not is_kamikaze:
            if health <= 20: return 'no_work', 120 
            if day_limit > 0 and sent_today >= day_limit: return 'no_work', 300

        # ==================================================
        # STRATEGY: SMART QUEUE (Priority Waterfall)
        # ==================================================
        
        task = None
        task_source = ""
        
        # Priority 1: Buffer (Previously Reserved)
        task = execute_query(
            "SELECT id, vk_user_id, name, avatar FROM recipients WHERE locked_by_account_id=? AND status='reserved' AND project_id=? LIMIT 1", 
            (account_id, project_id), 
            fetch_one=True
        )
        
        if task: task_source = "Buffer"
        
        # Priority 2: Warm Leads (Sticky Dialogs)
        if not task:
            task = execute_query("""
                SELECT r.id, r.vk_user_id, r.name, r.avatar 
                FROM recipients r
                JOIN conversations c ON c.peer_id = r.vk_user_id
                WHERE r.campaign_name=? AND r.status='queued' AND c.owner_id=? AND r.project_id=?
                LIMIT 1
            """, (campaign_name, str(account_id), project_id), fetch_one=True)
            
            if task:
                execute_query("UPDATE recipients SET locked_by_account_id=?, status='reserved', locked_until=datetime('now', '+30 minutes') WHERE id=?", (account_id, task['id']), commit=True)
                task_source = "Warm (Dialog)"

        # Priority 3: Sticky Friends (Cache)
        if not task:
            friends_csv = acc_dict.get('cached_friends_list', '')
            if friends_csv:
                candidates = execute_query(
                    "SELECT id, vk_user_id FROM recipients WHERE campaign_name=? AND status='queued' AND project_id=? LIMIT 300", 
                    (campaign_name, project_id), 
                    fetch_all=True
                )
                
                if candidates:
                    friend_set = set(friends_csv.split(','))
                    target_id = None
                    for cand in candidates:
                        if str(cand['vk_user_id']) in friend_set:
                            target_id = cand['id']
                            break
                    
                    if target_id:
                        execute_query("UPDATE recipients SET locked_by_account_id=?, status='reserved', locked_until=datetime('now', '+30 minutes') WHERE id=? AND status='queued'", (account_id, target_id), commit=True)
                        task = execute_query("SELECT id, vk_user_id, name, avatar FROM recipients WHERE id=?", (target_id,), fetch_one=True)
                        if task: task_source = "Warm (Friend)"

        # Priority 4: Cold Batch (Project Scoped)
        if not task:
            execute_query("""
                UPDATE recipients 
                SET locked_by_account_id = ?, 
                    locked_until = datetime('now', '+30 minutes'),
                    status = 'reserved'
                WHERE id IN (
                    SELECT id FROM recipients 
                    WHERE campaign_name = ? 
                      AND status = 'queued' 
                      AND locked_by_account_id IS NULL
                      AND project_id = ?
                    LIMIT 5
                )
            """, (account_id, campaign_name, project_id), commit=True)
            
            task = execute_query(
                "SELECT id, vk_user_id, name, avatar FROM recipients WHERE locked_by_account_id=? AND status='reserved' AND project_id=? LIMIT 1", 
                (account_id, project_id), 
                fetch_one=True
            )
            
            if task: task_source = "Cold Batch"

        # ==================================================
        # EXECUTION PHASE
        # ==================================================
        
        if not task: return 'no_work', 10 

        r_id = task['id']
        vk_id = str(task['vk_user_id'])
        r_name = task['name']
        
        # 4. FILTER
        should_skip = False
        if settings.get('skip_if_dialog_exists'):
            if task_source == "Warm (Dialog)": should_skip = True
            elif check_history_exists(acc['access_token'], vk_id): should_skip = True
        
        if should_skip:
            log_system("INFO", f"[{acc['name']}] Skipping [ID:{vk_id}] (Dialog Exists)")
            execute_query("UPDATE recipients SET status='skipped', locked_by_account_id=NULL, locked_until=NULL WHERE id=?", (r_id,), commit=True)
            return 'work_done', 1 

        # 5. ACTION: Friend
        # GROUPS cannot receive friend requests (IDs start with -)
        if settings.get('add_friends') and not vk_id.startswith('-'):
             try:
                 add_friend(acc['access_token'], vk_id)
                 time.sleep(random.uniform(1, 2))
             except: pass

        # 6. ACTION: Generate & Send
        text = generate_text(templates_pool, constructor_options, campaign_name)
        text = process_spintax(text)
        if r_name: text = text.replace('{имя}', r_name.split()[0])

        log_system("INFO", f"[{acc['name']}] Sending to [ID:{vk_id}] ({task_source})")
        
        is_friend_check = (task_source == "Warm (Friend)")
        
        # PASS USER AGENT HERE
        result_data, success = send_message_core(
            dict(acc), 
            vk_id, 
            text, 
            attachments or [], 
            is_friend_declared=is_friend_check,
            user_agent=user_agent 
        )
        
        if success:
            execute_query("UPDATE recipients SET status='sent', crm_status='progress', locked_by_account_id=NULL, locked_until=NULL WHERE id=?", (r_id,), commit=True)
            u_info = {'name': r_name, 'avatar': task['avatar']}
            update_conversation_db(dict(acc), vk_id, u_info, text, attachments or [], campaign_name, msg_id=result_data)
        else:
            log_system("ERROR", f"[{acc['name']}] Failed [ID:{vk_id}]: {result_data}")
            execute_query("UPDATE recipients SET status=?, locked_by_account_id=NULL, locked_until=NULL WHERE id=?", (f"Error: {result_data}", r_id), commit=True)

        # 7. SLEEP
        delay_mode = settings.get('delay_mode', 'manual')
        sleep_time = 0
        if delay_mode == 'manual':
            d_min = settings.get('delay_min', 5)
            d_max = settings.get('delay_max', 15)
            sleep_time = random.uniform(d_min, d_max)
        else:
            health = update_account_health(account_id, 'check')
            sleep_time = get_adaptive_delay(health)
            
        if is_kamikaze: sleep_time = random.uniform(1, 3)

        return 'work_done', sleep_time
    except Exception as e:
        log_system("ERROR", f"Step failed: {e}")
        return 'error', 60
