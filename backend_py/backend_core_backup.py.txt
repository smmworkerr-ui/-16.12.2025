
import os
import glob
import shutil
from datetime import datetime
from backend_core import DB_FILE, BACKUP_DIR, execute_query, log_system

# === BACKUP SYSTEM (KAIZEN SECURITY) ===

def ensure_backup_dir():
    if not os.path.exists(BACKUP_DIR):
        os.makedirs(BACKUP_DIR)

def create_backup(manual=False):
    """
    –°–æ–∑–¥–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—è VACUUM INTO.
    –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–∞–∂–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ (WAL).
    """
    try:
        ensure_backup_dir()
        
        # –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏: main_YYYY-MM-DD_HH-MM-SS.db
        timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        backup_name = f"main_{timestamp}.db"
        backup_path = os.path.join(BACKUP_DIR, backup_name)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º SQL VACUUM INTO –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –∫–æ–ø–∏–∏
        execute_query(f"VACUUM INTO ?", (backup_path,), commit=True)
        
        log_system("INFO", f"üíæ Backup created: {backup_name}")
        
        # Rotation: Keep last 5
        rotate_backups()
        return backup_name
        
    except Exception as e:
        log_system("ERROR", f"Backup failed: {e}")
        return None

def rotate_backups(keep=5):
    """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N."""
    try:
        files = glob.glob(os.path.join(BACKUP_DIR, "main_*.db"))
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –≤ –∫–æ–Ω—Ü–µ)
        files.sort(key=os.path.getmtime)
        
        if len(files) > keep:
            to_delete = files[:-keep]
            for f in to_delete:
                os.remove(f)
                print(f"[CLEANUP] Deleted old backup: {os.path.basename(f)}")
    except Exception as e:
        print(f"[CLEANUP ERROR] {e}")

def get_backups_list():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤."""
    ensure_backup_dir()
    files = glob.glob(os.path.join(BACKUP_DIR, "main_*.db"))
    backups = []
    for f in files:
        stats = os.stat(f)
        backups.append({
            'filename': os.path.basename(f),
            'size': stats.st_size,
            'created_at': stats.st_mtime
        })
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
    backups.sort(key=lambda x: x['created_at'], reverse=True)
    return backups

def restore_backup(filename):
    """
    –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ë–î –∏–∑ –±—ç–∫–∞–ø–∞.
    –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –ë–î.
    """
    source = os.path.join(BACKUP_DIR, filename)
    if not os.path.exists(source):
        raise Exception("Backup file not found")
        
    try:
        # 1. –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ WAL/SHM —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        wal_file = DB_FILE + "-wal"
        shm_file = DB_FILE + "-shm"
        
        if os.path.exists(wal_file): os.remove(wal_file)
        if os.path.exists(shm_file): os.remove(shm_file)
        
        # 2. –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
        shutil.copy2(source, DB_FILE)
        
        log_system("WARNING", f"‚ôªÔ∏è DATABASE RESTORED FROM {filename}")
        return True
    except Exception as e:
        log_system("CRITICAL", f"Restore failed: {e}")
        raise e
