
from flask import request, jsonify
import threading
from backend_core import app, execute_query
from backend_tools import vk_api_call

def sync_unread_worker():
    """Фоновая задача: обновление диалогов и создание НОВЫХ (Прямые сообщения)."""
    # Fetch accounts WITH project_id
    accounts = execute_query("SELECT id, access_token, project_id FROM accounts WHERE status='OK'", fetch_all=True)
    
    for acc in accounts:
        try:
            res = vk_api_call('messages.getConversations', {'count': 40, 'extended': 1}, acc['access_token'])
            if 'response' in res:
                items = res['response']['items']
                profiles = res['response'].get('profiles', [])
                groups = res['response'].get('groups', [])
                
                names_map = {}
                for p in profiles: names_map[p['id']] = f"{p['first_name']} {p['last_name']}"
                for g in groups: names_map[-g['id']] = g['name']
                
                avatars_map = {}
                for p in profiles: avatars_map[p['id']] = p.get('photo_100', '')
                for g in groups: avatars_map[-g['id']] = g.get('photo_100', '')

                for item in items:
                    conv = item['conversation']
                    last_msg = item.get('last_message', {})
                    peer_id = conv['peer']['id']
                    db_id = f"{acc['id']}_{peer_id}"
                    
                    unread_count = conv.get('unread_count', 0)
                    text_preview = last_msg.get('text', '')
                    if not text_preview and last_msg.get('attachments'):
                        text_preview = f"[Вложение: {last_msg['attachments'][0]['type']}]"
                        
                    name = names_map.get(peer_id, f"User {peer_id}")
                    avatar = avatars_map.get(peer_id, '')
                    
                    # Update Existing: Ensure project_id matches account's project_id if not set? 
                    # Actually, better to enforce it matches the account's project.
                    updated = execute_query("""
                        UPDATE conversations 
                        SET unread_count=?, last_message=?, name=?, avatar=?, project_id=?
                        WHERE id=?
                    """, (unread_count, text_preview, name, avatar, acc['project_id'], db_id), commit=True)
                    
                    if updated == 0:
                        execute_query("""
                            INSERT INTO conversations (id, owner_id, peer_id, name, avatar, last_message, unread_count, campaign_name, project_id)
                            VALUES (?, ?, ?, ?, ?, ?, ?, NULL, ?)
                        """, (db_id, str(acc['id']), str(peer_id), name, avatar, text_preview, unread_count, acc['project_id']), commit=True)
                    
                    # Ensure Recipient Exists (Direct)
                    # We check if recipient exists FOR THIS PROJECT
                    rec_exist = execute_query("SELECT id FROM recipients WHERE vk_user_id=? AND project_id=?", (str(peer_id), acc['project_id']), fetch_one=True)
                    if not rec_exist:
                        execute_query("""
                            INSERT INTO recipients (vk_user_id, name, avatar, status, campaign_name, crm_status, can_message, project_id)
                            VALUES (?, ?, ?, 'chat', 'Manual', 'new', 1, ?)
                        """, (str(peer_id), name, avatar, acc['project_id']), commit=True)

                    # === AUTOMATION: AUTO STATUS CHANGE ===
                    if last_msg.get('out') == 0:
                        rec = execute_query("SELECT id, crm_status FROM recipients WHERE vk_user_id=? AND project_id=?", (str(peer_id), acc['project_id']), fetch_one=True)
                        if rec and rec['crm_status'] == 'new':
                            print(f"[AUTO-STATUS] Updating {peer_id} from 'new' to 'progress' on incoming message (Project {acc['project_id']}).")
                            execute_query("UPDATE recipients SET crm_status='progress' WHERE id=?", (rec['id'],), commit=True)

        except Exception as e:
            print(f"[SYNC ERROR] Account {acc['id']}: {e}")

@app.route('/api/conversations/sync', methods=['POST'])
def sync_conversations():
    threading.Thread(target=sync_unread_worker).start()
    return jsonify({'status': 'sync_started'})

@app.route('/api/conversations/<id>/read', methods=['POST'])
def mark_conversation_read(id):
    if '_' not in id: return jsonify({'error': 'Bad ID'}), 400
    execute_query("UPDATE conversations SET unread_count=0 WHERE id=?", (id,), commit=True)
    owner_id, peer_id = id.split('_')
    acc = execute_query("SELECT access_token FROM accounts WHERE id=?", (owner_id,), fetch_one=True)
    if acc:
        def vk_mark():
            vk_api_call('messages.markAsRead', {'peer_id': peer_id}, acc['access_token'])
        threading.Thread(target=vk_mark).start()
    return jsonify({'status': 'ok'})
